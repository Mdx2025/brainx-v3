# Database schema (BrainX V3)

Source of truth: [`sql/v3-schema.sql`](../sql/v3-schema.sql)

BrainX V3 uses PostgreSQL tables prefixed with `brainx_`.

> Prerequisite: `CREATE EXTENSION IF NOT EXISTS vector;`

## Table: `brainx_memories`

The main memory store.

### Purpose

Stores atomic memory items (decisions, actions, notes, learnings, etc.) plus metadata used for retrieval.

### Columns

- `id` (text, PK)
  - caller-provided or auto-generated by the CLI.
- `type` (text)
  - must be one of: `decision | action | learning | gotcha | note | feature_request`
- `content` (text)
  - the text payload.
- `context` (text, nullable)
  - exact-match scope key. Examples:
    - `openclaw`
    - `emailbot`
    - `workspace-coder/MEMORY.md`
- `tier` (text, default `warm`)
  - `hot | warm | cold | archive`
- `agent` (text, nullable)
  - which agent/system wrote it.
- `importance` (int 1..10, default 5)
  - used for ranking.
- `embedding` (`vector(1536)`)
  - vector embedding used by pgvector. **Must match** `OPENAI_EMBEDDING_DIMENSIONS`.
- `created_at` (timestamptz)
- `last_accessed` (timestamptz)
- `access_count` (int)
  - access tracking updated on search.
- `source_session` (text, nullable)
  - intended to link to a conversation/session id.
- `superseded_by` (text, nullable)
  - points to the “kept” memory when this one is superseded/deduped.
- `tags` (text[])

### Indexes

- `idx_mem_embedding` — ivfflat on `embedding` (cosine)
- `idx_mem_tier` — `(tier, importance desc)`
- `idx_mem_context` — `(context)`
- `idx_mem_tags` — GIN index

### Notes

- Queries exclude superseded memories via `WHERE superseded_by IS NULL`.
- Dedup is implemented by setting `superseded_by` and tagging the old rows.

## Table: `brainx_learning_details`

Optional structured details for `learning` memories.

### Purpose

Captures “post-mortem” / debugging fields that are hard to consistently fit in plain text.

This table is not yet written by the CLI, but the schema supports it.

### Key columns

- `memory_id` (PK, FK → `brainx_memories.id`)
- `category`
- `what_was_wrong` / `what_is_correct`
- `source`, `error_message`, `stack_trace`
- `command_attempted`
- `related_files` (text[])
- `complexity` (`simple|medium|complex`)
- promotion fields: `promotion_status`, `promoted_to`, `promoted_at`

## Table: `brainx_trajectories`

### Purpose

Stores “how we solved it” multi-step solutions as reusable trajectories.

- `steps` is `jsonb`.
- Has its own `embedding` and `times_used` counter.

## Table: `brainx_context_packs`

### Purpose

Stores larger “packed context” blobs (`data` as `jsonb`) to inject into prompts.

Has an `embedding` so packs can be retrieved by semantic similarity.

## Table: `brainx_session_snapshots`

### Purpose

Stores session-level summaries, status, blockers and pending items.

Useful for: resuming work after long gaps.

## Table: `brainx_pilot_log`

### Purpose

Stores operational telemetry about injections (tokens, recall triggers, compression flags, etc.).

This is optional and can be disabled if not needed.

## Operational considerations

### pgvector and ivfflat

- ivfflat indexes require `ANALYZE` and enough rows to be useful.
- You may want to tune `lists` per table size.

### Dimension changes

If you change `OPENAI_EMBEDDING_DIMENSIONS`, you must also:

- change `vector(1536)` in schema
- rebuild embeddings for existing rows

### Backups

A standard Postgres backup is enough (e.g. `pg_dump`).
